<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teachable Machine</title>
<style>
body {
  margin: 0;
  padding: 0;
  background: black;
  color: white;
  font-family: "Segoe UI", sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
}

h1 {
  margin: 40px 0 20px;
  font-size: 36px;
  font-weight: 500;
}

.class-container {
  display: flex;
  gap: 20px;
  margin-top: 30px;
  flex-wrap: wrap;
  justify-content: center;
}

.class-box {
  background: white;
  color: black;
  border-radius: 12px;
  width: 500px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  display: flex;
  flex-direction: column;
  gap: 15px;
  position: relative;
  transition: transform 0.2s;
}

.class-box:hover {
  transform: translateY(-3px);
}

.class-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 20px;
  font-weight: bold;
}

.class-header span[contenteditable="true"] {
  outline: none;
  border-bottom: 1px dashed transparent;
}

.class-header span[contenteditable="true"]:focus {
  border-bottom: 1px dashed black;
}

.menu {
  position: relative;
  cursor: pointer;
  font-size: 20px;
  user-select: none;
}

.menu-options {
  display: none;
  position: absolute;
  right: 0;
  top: 25px;
  background: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  z-index: 10;
  min-width: 180px;
}

.menu-options div {
  padding: 10px 15px;
  cursor: pointer;
  font-size: 14px;
  color: black;
}

.menu-options div:hover {
  background: #f2f2f2;
}

/* global disabled-option definition */
.disabled-option {
  color: #aaa !important;
  pointer-events: none;
}

.sample-label {
  font-size: 16px;
  color: #444;
}

.btn-row {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  background: #f1f1f1;
  color: black;
}

.btn:hover {
  background: #ddd;
}

.hold-record-row {
  display: none;
  gap: 10px;
  justify-content: center;
}

.video-preview-container {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
  margin-top: 10px;
  align-items: flex-start;
}

.video-container {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
}

video {
  width: 300px;
  border-radius: 8px;
  display: none;
}

.close-video-btn {
  position: absolute;
  top: -6px;
  right: -6px;
  background: red;
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 12px;
  width: 20px;
  height: 20px;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2;
  display: none;
}

/* FLEXBOX layout for captured images */
.samples-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  max-height: 220px;
  overflow-y: auto;
  padding: 4px;
  align-content: flex-start;
  justify-content: center;
}

.sample-item {
  position: relative;
  display: inline-block;
}

.sample-item img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 6px;
}

.remove-img-btn {
  position: absolute;
  top: -4px;
  right: -4px;
  background: red;
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 12px;
  width: 18px;
  height: 18px;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2;
}

.add-class {
  border: 2px dashed #777;
  border-radius: 12px;
  width: 500px;
  height: 200px;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #aaa;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.2s;
}

.add-class:hover {
  border-color: #2d2dff;
  color: #2d2dff;
}

/* Lightbox modal */
#imgModal {
  display: none;
  position: fixed;
  z-index: 100;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.9);
  justify-content: center;
  align-items: center;
}

#imgModal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 10px;
  box-shadow: 0 0 15px #fff;
}

#imgModal span {
  position: absolute;
  top: 20px;
  right: 30px;
  color: white;
  font-size: 35px;
  font-weight: bold;
  cursor: pointer;
}
</style>
</head>

<body>
<h1>Teachable Machine</h1>

<div class="class-container" id="classContainer">
  <div class="class-box">
    <div class="class-header">
      <span contenteditable="true">Class 1</span>
      <div class="menu" onclick="toggleMenu(this)">‚ãÆ
        <div class="menu-options">
          <div onclick="deleteClass(this)">Delete class</div>
          <div onclick="removeSamples(this)" class="disabled-option">Remove All Samples</div>
          <div onclick="downloadSamples(this)" class="disabled-option">Download Samples</div>
        </div>
      </div>
    </div>
    <div class="sample-label">Add image Samples:</div>
    <div class="btn-row">
      <button class="btn webcam-btn">üì∑ Webcam</button>
      <button class="btn upload-btn">‚¨ÜÔ∏è Upload</button>
    </div>
    <div class="btn-row hold-record-row">
      <button class="btn hold-record-btn">‚è∫ Hold & Record</button>
    </div>
    <div class="video-preview-container">
      <div class="video-container">
        <video autoplay playsinline></video>
        <button class="close-video-btn">‚ùå</button>
      </div>
      <div class="samples-preview"></div>
    </div>
  </div>
  <div class="add-class" onclick="addClassBox()">+ Add a class</div>
</div>

<div id="imgModal">
  <span onclick="document.getElementById('imgModal').style.display='none'">&times;</span>
  <img id="modalImg">
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
/* ---------------------------
   Global variables & helpers
   --------------------------- */
const classContainer = document.getElementById('classContainer');
const classTemplate = document.querySelector('.class-box').cloneNode(true);
let classCount = 1;

function toggleMenu(el) {
  const menu = el.querySelector('.menu-options');
  const isOpen = menu.style.display === "block";
  document.querySelectorAll('.menu-options').forEach(m => m.style.display = "none");
  menu.style.display = isOpen ? "none" : "block";
}

window.addEventListener("click", e => {
  if(!e.target.closest(".menu")) 
    document.querySelectorAll('.menu-options').forEach(m=>m.style.display="none");
});

/* Global update function - moved here so global functions can call it */
function updateMenuOptions(box){
  if(!box) return;
  const preview = box.querySelector('.samples-preview');
  const hasImages = preview && preview.querySelectorAll('img').length > 0;
  const menuOptions = box.querySelectorAll('.menu-options div');

  menuOptions.forEach(opt => {
    const txt = (opt.textContent || "").trim();
    // match by keywords to be robust
    if(txt.includes("Remove All") || txt.includes("Download")){
      if(hasImages) opt.classList.remove('disabled-option');
      else opt.classList.add('disabled-option');
    }
  });
}

/* ---------------------------
   Global action functions
   --------------------------- */

function deleteClass(el) {
  const classBox = el.closest('.class-box');
  const video = classBox.querySelector('video');
  if(video && video.srcObject) video.srcObject.getTracks().forEach(track=>track.stop());
  classBox.remove();
}

function removeSamples(el) { 
  const classBox = el.closest('.class-box');
  const preview = classBox.querySelector('.samples-preview');
  preview.innerHTML = "";            // Remove all images
  updateMenuOptions(classBox);       // Update menu buttons
  // optionally close the menu
  const menu = classBox.querySelector('.menu-options');
  if(menu) menu.style.display = 'none';
}

function downloadSamples(el) {
  const classBox = el.closest('.class-box');
  const className = classBox.querySelector('.class-header span').textContent.trim() || "class";
  const zip = new JSZip();
  classBox.querySelectorAll('.samples-preview img').forEach((img,i)=>{
    const data = img.src.split(',')[1];
    zip.file(`${className}_${i+1}.png`, data, {base64:true});
  });
  zip.generateAsync({type:"blob"}).then(content=>{
    const link = document.createElement('a');
    link.href = URL.createObjectURL(content);
    link.download = `${className}.zip`;
    link.click();
  });
}

/* ---------------------------
   Class creation & webcam init
   --------------------------- */

function addClassBox(){
  classCount++;
  const classBox = classTemplate.cloneNode(true);
  classBox.querySelector('.class-header span').textContent = `Class ${classCount}`;
  classContainer.insertBefore(classBox, classContainer.lastElementChild);
  initWebcam(classBox);
  updateMenuOptions(classBox); // ensure initial state
}

function initWebcam(classBox){
  const webcamBtn = classBox.querySelector('.webcam-btn');
  const video = classBox.querySelector('video');
  const preview = classBox.querySelector('.samples-preview');
  const holdRow = classBox.querySelector('.hold-record-row');
  const holdBtn = holdRow.querySelector('.hold-record-btn');
  const closeBtn = classBox.querySelector('.close-video-btn');
  const btnRow = classBox.querySelector('.btn-row');
  const uploadBtn = classBox.querySelector('.upload-btn');

  let stream = null;
  let interval = null;

  // Start webcam
  webcamBtn.addEventListener('click', async () => {
    try {
      if(!stream){
        stream = await navigator.mediaDevices.getUserMedia({video:true});
        video.srcObject = stream;
        video.style.display="block";
        closeBtn.style.display="flex";
      }
      holdRow.style.display="flex";
      // move the btn-row next to video for better UX
      if(video.parentNode && btnRow) video.parentNode.insertBefore(btnRow, video.nextSibling);
    } catch(err){
      console.error("Camera access denied or error:", err);
      alert("Unable to access camera. Check permissions.");
    }
  });

  // Hold & record images
  holdBtn.addEventListener('mousedown', () => { interval = setInterval(()=>captureImage(),300); });
  holdBtn.addEventListener('mouseup',()=>clearInterval(interval));
  holdBtn.addEventListener('mouseleave',()=>clearInterval(interval));

  // Close webcam
  closeBtn.addEventListener('click', ()=>{
    if(stream){
      stream.getTracks().forEach(track=>track.stop());
      stream = null;
    }
    video.style.display = "none";
    closeBtn.style.display = "none";
    holdRow.style.display = "none";
    // move btnRow back to original place (before holdRow)
    if(classBox && btnRow && holdRow) classBox.insertBefore(btnRow, holdRow);
  });

  // Upload images
  uploadBtn.addEventListener('click', ()=>{
    const input = document.createElement('input');
    input.type='file';
    input.accept='image/*';
    input.multiple=true;
    input.onchange = e => {
      Array.from(input.files).forEach(file=>{
        const reader = new FileReader();
        reader.onload = ev=> addImageToPreview(ev.target.result);
        reader.readAsDataURL(file);
      });
    };
    input.click();
  });

  // Capture image from video
  function captureImage(){
    if(!video || video.readyState < 2) return;
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    addImageToPreview(canvas.toDataURL("image/png"));
  }

  // Add image to preview and update menu buttons
  function addImageToPreview(src){
    const imgContainer = document.createElement('div');
    imgContainer.classList.add('sample-item');

    const img = document.createElement('img');
    img.src = src;

    // Open in modal on click
    img.addEventListener('click', ()=>{
      const modal = document.getElementById('imgModal');
      const modalImg = document.getElementById('modalImg');
      modal.style.display = 'flex';
      modalImg.src = src;
    });

    const removeBtn = document.createElement('button');
    removeBtn.classList.add('remove-img-btn');
    removeBtn.textContent='‚ùå';
    removeBtn.onclick = ()=>{
      imgContainer.remove();
      updateMenuOptions(classBox); // Ensure menu updates when single image is removed
    };

    imgContainer.appendChild(img);
    imgContainer.appendChild(removeBtn);
    preview.appendChild(imgContainer);
    preview.scrollTop = preview.scrollHeight;

    updateMenuOptions(classBox); // Ensure menu updates after new image is added
  }

  // initialize menu state for this class box
  updateMenuOptions(classBox);
}

/* Initialize all existing class boxes on page load */
document.querySelectorAll('.class-box').forEach(initWebcam);
</script>

</body>
</html>
